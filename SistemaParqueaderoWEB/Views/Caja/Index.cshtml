@model SistemaParqueaderoWEB.Models.CierreCajaViewModel
@{
    ViewData["Title"] = "Caja";
}

<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="fw-semibold mb-1">Gestión de Caja</h4>
        <p class="text-muted mb-0">Estado actual y resumen del día</p>
    </div>
    <div>
        @if (!Model.CajaAbierta && Model.CierreActual == null)
        {
            <a asp-action="CerrarCaja" class="btn btn-primary">
                <iconify-icon icon="solar:wallet-money-line-duotone" class="me-1"></iconify-icon>
                Cerrar Caja
            </a>
        }
        <a asp-action="Historial" class="btn btn-light border ms-2">
            <iconify-icon icon="solar:history-line-duotone" class="me-1"></iconify-icon>
            Ver Historial
        </a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <iconify-icon icon="solar:check-circle-line-duotone" class="me-2"></iconify-icon>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <iconify-icon icon="solar:danger-triangle-line-duotone" class="me-2"></iconify-icon>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (Model.CierreActual != null)
{
    <!-- Caja cerrada - Mostrar información del cierre -->
    <div class="card border-top border-top-4 border-top-success mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="card-title fw-semibold mb-0">
                    <iconify-icon icon="solar:check-circle-line-duotone" class="me-2 text-success"></iconify-icon>
                    Caja Cerrada
                </h5>
                <span class="badge bg-success">Cerrado</span>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <p class="mb-1 text-muted small">Fecha de cierre</p>
                    <strong>@Model.CierreActual.FechaCierreReal.ToString("dd/MM/yyyy HH:mm")</strong>
                </div>
                <div class="col-md-3">
                    <p class="mb-1 text-muted small">Usuario</p>
                    <strong>@Model.CierreActual.Usuario?.NombreCompleto</strong>
                </div>
                <div class="col-md-3">
                    <p class="mb-1 text-muted small">Monto total</p>
                    <strong class="text-success fs-5">
                        @Model.CierreActual.MontoTotal.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                    </strong>
                </div>
                <div class="col-md-3">
                    <p class="mb-1 text-muted small">Diferencia</p>
                    <strong class="@(Model.CierreActual.Diferencia >= 0 ? "text-success" : "text-danger")">
                        @(Model.CierreActual.Diferencia?.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO")) ?? "$0.00")
                    </strong>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Caja abierta - Mostrar resumen del día -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-top border-top-4 border-top-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <iconify-icon icon="solar:calendar-mark-line-duotone" style="font-size: 2rem; color: #258cfb;"></iconify-icon>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 text-muted small">Total registros</p>
                            <h4 class="mb-0 fw-semibold">@Model.TotalRegistros</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-top border-top-4 border-top-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <iconify-icon icon="solar:car-line-duotone" style="font-size: 2rem; color: #06b6d4;"></iconify-icon>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 text-muted small">Carros</p>
                            <h4 class="mb-0 fw-semibold">@Model.TotalCarros</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-top border-top-4 border-top-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <iconify-icon icon="solar:motorcycle-line-duotone" style="font-size: 2rem; color: #f59e0b;"></iconify-icon>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 text-muted small">Motos</p>
                            <h4 class="mb-0 fw-semibold">@Model.TotalMotos</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-top border-top-4 border-top-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <iconify-icon icon="solar:dollar-minimalistic-line-duotone" style="font-size: 2rem; color: #10b759;"></iconify-icon>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 text-muted small">Monto esperado</p>
                            <h4 class="mb-0 fw-semibold text-success">
                                @Model.MontoEsperado.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Montos por método de pago -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title fw-semibold mb-3">
                <iconify-icon icon="solar:wallet-money-line-duotone" class="me-2"></iconify-icon>
                Resumen por método de pago
            </h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                        <div>
                            <p class="mb-1 text-muted small">Efectivo</p>
                            <h5 class="mb-0 fw-semibold text-success">
                                @Model.MontoEfectivo.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                            </h5>
                        </div>
                        <iconify-icon icon="solar:wallet-money-line-duotone" style="font-size: 2rem; color: #10b759;"></iconify-icon>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                        <div>
                            <p class="mb-1 text-muted small">Tarjeta</p>
                            <h5 class="mb-0 fw-semibold text-info">
                                @Model.MontoTarjeta.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                            </h5>
                        </div>
                        <iconify-icon icon="solar:card-line-duotone" style="font-size: 2rem; color: #06b6d4;"></iconify-icon>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded">
                        <div>
                            <p class="mb-1 text-muted small">Transferencia</p>
                            <h5 class="mb-0 fw-semibold text-primary">
                                @Model.MontoTransferencia.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                            </h5>
                        </div>
                        <iconify-icon icon="solar:transfer-horizontal-line-duotone" style="font-size: 2rem; color: #258cfb;"></iconify-icon>
                    </div>
                </div>
            </div>
            <hr class="my-3" />
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Total del día</h5>
                <h4 class="mb-0 fw-semibold text-success">
                    @Model.MontoTotal.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                </h4>
            </div>
        </div>
    </div>

    <!-- Botón para cerrar caja -->
    <div class="card">
        <div class="card-body text-center py-4">
            <iconify-icon icon="solar:wallet-money-line-duotone" style="font-size: 3rem; color: #258cfb;"></iconify-icon>
            <h5 class="mb-2 mt-3">Caja abierta</h5>
            <p class="text-muted mb-4">
                Puedes cerrar la caja al finalizar el día para registrar los movimientos.
            </p>
            <a asp-action="CerrarCaja" class="btn btn-primary btn-lg">
                <iconify-icon icon="solar:wallet-money-line-duotone" class="me-2"></iconify-icon>
                Cerrar Caja
            </a>
        </div>
    </div>
}

<!-- Historial reciente -->
@if (Model.HistorialCierres.Any())
{
    <div class="card mt-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="card-title fw-semibold mb-0">
                    <iconify-icon icon="solar:history-line-duotone" class="me-2"></iconify-icon>
                    Historial reciente
                </h5>
                <a asp-action="Historial" class="btn btn-sm btn-outline-primary">
                    Ver todo
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="fw-semibold">Fecha</th>
                            <th class="fw-semibold">Usuario</th>
                            <th class="fw-semibold">Registros</th>
                            <th class="fw-semibold">Monto total</th>
                            <th class="fw-semibold">Diferencia</th>
                            <th class="fw-semibold text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cierre in Model.HistorialCierres.Take(5))
                        {
                            <tr>
                                <td>
                                    <div class="small">@cierre.FechaCierre.ToString("dd/MM/yyyy")</div>
                                    <div class="text-muted small">@cierre.FechaCierreReal.ToString("HH:mm")</div>
                                </td>
                                <td>@(cierre.Usuario?.NombreCompleto ?? "-")</td>
                                <td>
                                    <span class="badge bg-secondary">@cierre.TotalRegistros</span>
                                </td>
                                <td>
                                    <strong class="text-success">
                                        @cierre.MontoTotal.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                                    </strong>
                                </td>
                                <td>
                                    <span class="@(cierre.Diferencia >= 0 ? "text-success" : "text-danger")">
                                        @(cierre.Diferencia?.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO")) ?? "$0.00")
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a asp-action="DetalleCierre" asp-route-id="@cierre.Id" class="btn btn-sm btn-outline-primary">
                                        <iconify-icon icon="solar:eye-line-duotone"></iconify-icon>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
