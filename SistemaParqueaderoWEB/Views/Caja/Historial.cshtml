@model IEnumerable<SistemaParqueaderoWEB.Models.CierreCaja>
@{
    ViewData["Title"] = "Historial de Cierres";
    var fechaDesde = ViewBag.FechaDesde as DateTime?;
    var fechaHasta = ViewBag.FechaHasta as DateTime?;
}

<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="fw-semibold mb-1">Historial de Cierres de Caja</h4>
        <p class="text-muted mb-0">Consulta los cierres de caja anteriores</p>
    </div>
    <a asp-action="Index" class="btn btn-light border">
        <iconify-icon icon="solar:arrow-left-line-duotone" class="me-1"></iconify-icon>
        Volver
    </a>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="fechaDesde" class="form-label small text-muted">Fecha desde</label>
                <input type="date" 
                       id="fechaDesde" 
                       name="fechaDesde" 
                       class="form-control form-control-sm" 
                       value="@(fechaDesde?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-4">
                <label for="fechaHasta" class="form-label small text-muted">Fecha hasta</label>
                <input type="date" 
                       id="fechaHasta" 
                       name="fechaHasta" 
                       class="form-control form-control-sm" 
                       value="@(fechaHasta?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm me-2">
                    <iconify-icon icon="solar:magnifer-line-duotone" class="me-1"></iconify-icon>
                    Buscar
                </button>
                <a asp-action="Historial" class="btn btn-outline-secondary btn-sm">
                    Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

@if (!Model.Any())
{
    <div class="card">
        <div class="card-body text-center py-5">
            <iconify-icon icon="solar:history-line-duotone" style="font-size: 4rem; color: #ccc;"></iconify-icon>
            <h5 class="mb-2 mt-3">No hay cierres registrados</h5>
            <p class="text-muted mb-0">
                No se encontraron cierres de caja para el per√≠odo seleccionado.
            </p>
        </div>
    </div>
}
else
{
    <!-- Resumen -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-top border-top-4 border-top-primary">
                <div class="card-body">
                    <p class="mb-1 text-muted small">Total cierres</p>
                    <h4 class="mb-0 fw-semibold">@Model.Count()</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-top border-top-4 border-top-success">
                <div class="card-body">
                    <p class="mb-1 text-muted small">Total recaudado</p>
                    <h4 class="mb-0 fw-semibold text-success">
                        @Model.Sum(c => c.MontoTotal).ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                    </h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-top border-top-4 border-top-info">
                <div class="card-body">
                    <p class="mb-1 text-muted small">Promedio diario</p>
                    <h4 class="mb-0 fw-semibold">
                        @(Model.Any() ? (Model.Sum(c => c.MontoTotal) / Model.Count()).ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO")) : "$0.00")
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de cierres -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="fw-semibold">Fecha</th>
                            <th class="fw-semibold">Usuario</th>
                            <th class="fw-semibold">Registros</th>
                            <th class="fw-semibold">Efectivo</th>
                            <th class="fw-semibold">Tarjeta</th>
                            <th class="fw-semibold">Transferencia</th>
                            <th class="fw-semibold">Total</th>
                            <th class="fw-semibold">Diferencia</th>
                            <th class="fw-semibold text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cierre in Model)
                        {
                            <tr>
                                <td>
                                    <div class="small">@cierre.FechaCierre.ToString("dd/MM/yyyy")</div>
                                    <div class="text-muted small">@cierre.FechaCierreReal.ToString("HH:mm")</div>
                                </td>
                                <td>@(cierre.Usuario?.NombreCompleto ?? "-")</td>
                                <td>
                                    <span class="badge bg-secondary">@cierre.TotalRegistros</span>
                                    <div class="small text-muted mt-1">
                                        üöó @cierre.TotalCarros | üèçÔ∏è @cierre.TotalMotos
                                    </div>
                                </td>
                                <td>
                                    <span class="text-success">
                                        @cierre.MontoEfectivo.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                                    </span>
                                </td>
                                <td>
                                    <span class="text-info">
                                        @cierre.MontoTarjeta.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                                    </span>
                                </td>
                                <td>
                                    <span class="text-primary">
                                        @cierre.MontoTransferencia.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                                    </span>
                                </td>
                                <td>
                                    <strong class="text-success">
                                        @cierre.MontoTotal.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO"))
                                    </strong>
                                </td>
                                <td>
                                    <span class="@(cierre.Diferencia >= 0 ? "text-success" : "text-danger")">
                                        @(cierre.Diferencia?.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-CO")) ?? "$0.00")
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a asp-action="DetalleCierre" asp-route-id="@cierre.Id" class="btn btn-sm btn-outline-primary">
                                        <iconify-icon icon="solar:eye-line-duotone" class="me-1"></iconify-icon>
                                        Ver detalle
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
